<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>COVID Narrative Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #fff3b0;
      margin: 20px;
    }

    .scene {
      display: none;
    }

    .active {
      display: block;
    }

    svg {
      margin-top: 20px;
      background-color: #fff;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    button {
      margin-right: 10px;
      margin-bottom: 10px;
      padding: 6px 12px;
      background-color: #ffe680;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background-color: #ffdf60;
    }
  </style>
</head>
<body>
  <h1>COVID Narrative Visualization</h1>
  <div>
    <button onclick="showScene(1)">Scene 1: Pie Chart</button>
    <button onclick="showScene(2)">Scene 2: Top 10 Deaths/100k</button>
    <button onclick="showScene(3)">Scene 3: Scatterplot</button>
  </div>

  <div id="scene1" class="scene"></div>
  <div id="scene2" class="scene"></div>
  <div id="scene3" class="scene"></div>

  <script>
    let data;

    d3.csv("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world_covid.csv").then(raw => {
      data = raw;
      data.forEach(d => {
        d.Confirmed = +d.Confirmed;
        d.Deaths = +d.Deaths;
        d.Recovered = +d.Recovered;
        d.Incident_Rate = +d.Incident_Rate;

        const pop = parseFloat(d.Population);
        d.Population = isNaN(pop) ? null : pop;

        d.Deaths_Per_100k = d.Population ? (d.Deaths / d.Population * 100000) : 0;
      });

      showScene(1);
    });

    function showScene(n) {
      d3.selectAll('.scene').classed('active', false);
      d3.select('#scene' + n).classed('active', true);

      if (n === 1) drawScene1();
      if (n === 2) drawScene2();
      if (n === 3) drawScene3();
    }

    function drawScene1() {
      const svg = d3.select('#scene1').html('').append('svg')
        .attr('width', 500)
        .attr('height', 500)
        .append('g')
        .attr('transform', 'translate(250,250)');

      const us = data.find(d => d.Country_Region === 'US');
      const pieData = [
        { label: 'Confirmed', value: us.Confirmed },
        { label: 'Deaths', value: us.Deaths },
        { label: 'Recovered', value: us.Recovered }
      ];

      const pie = d3.pie().value(d => d.value);
      const arc = d3.arc().innerRadius(0).outerRadius(150);
      const color = d3.scaleOrdinal(d3.schemeCategory10);

      svg.selectAll('path')
        .data(pie(pieData))
        .enter()
        .append('path')
        .attr('d', arc)
        .attr('fill', (d, i) => color(i));

      svg.selectAll('text')
        .data(pie(pieData))
        .enter()
        .append('text')
        .text(d => d.data.label)
        .attr('transform', d => `translate(${arc.centroid(d)})`)
        .style('text-anchor', 'middle')
        .style('fill', 'white');
    }

    function drawScene2() {
      const margin = { top: 30, right: 30, bottom: 50, left: 60 },
        width = 600 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

      const svg = d3.select('#scene2').html('').append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      const top = [...data].sort((a, b) => b.Deaths_Per_100k - a.Deaths_Per_100k).slice(0, 10);

      const x = d3.scaleBand()
        .domain(top.map(d => d.Country_Region))
        .range([0, width])
        .padding(0.2);

      const y = d3.scaleLinear()
        .domain([0, d3.max(top, d => d.Deaths_Per_100k)])
        .nice()
        .range([height, 0]);

      svg.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll("text")
        .attr("transform", "rotate(-40)")
        .style("text-anchor", "end");

      svg.append('g')
        .call(d3.axisLeft(y));

      svg.selectAll('rect')
        .data(top)
        .enter()
        .append('rect')
        .attr('x', d => x(d.Country_Region))
        .attr('y', d => y(d.Deaths_Per_100k))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d.Deaths_Per_100k))
        .attr('fill', 'steelblue');
    }

    function drawScene3() {
      const margin = { top: 30, right: 30, bottom: 50, left: 60 },
        width = 600 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

      const svg = d3.select('#scene3').html('').append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.Incident_Rate)])
        .nice()
        .range([0, width]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.Deaths_Per_100k)])
        .nice()
        .range([height, 0]);

      svg.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x));

      svg.append('g')
        .call(d3.axisLeft(y));

      svg.append('text')
        .attr('x', width / 2)
        .attr('y', height + 40)
        .style('text-anchor', 'middle')
        .text('Incident Rate');

      svg.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('x', -height / 2)
        .attr('y', -45)
        .style('text-anchor', 'middle')
        .text('Deaths per 100k');

      svg.selectAll('circle')
        .data(data)
        .enter()
        .append('circle')
        .attr('cx', d => x(d.Incident_Rate))
        .attr('cy', d => y(d.Deaths_Per_100k))
        .attr('r', 3)
        .attr('fill', 'orange')
        .attr('opacity', 0.7);
    }
  </script>
</body>
</html>
