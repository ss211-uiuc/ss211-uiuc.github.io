<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>COVID Narrative Visualization</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://unpkg.com/d3-annotation@2.5.1/d3-annotation.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 40px;
    }
    .scene-nav {
      margin-bottom: 10px;
    }
    svg {
      width: 100%;
      height: 600px;
    }
    .annotation-note-title {
      font-weight: bold;
    }
    .tooltip {
      position: absolute;
      text-align: center;
      padding: 5px;
      background: lightgray;
      border-radius: 5px;
      pointer-events: none;
      font-size: 12px;
    }
  </style>
</head>
<body>

  <h1>COVID-19 Global Summary â€” January 1, 2021</h1>
  <div class="scene-nav">
    <button id="prev">Previous</button>
    <span id="scene-title"></span>
    <button id="next">Next</button>
  </div>

  <svg id="vis"></svg>

  <script>
    const scenes = [scene1, scene2, scene3];
    let currentScene = 0;

    const svg = d3.select("#vis");
    const width = +svg.attr("width") || 960;
    const height = +svg.attr("height") || 600;
    const radius = Math.min(width, height) / 3;
    const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

    d3.csv("01-01-2021.csv").then(data => {
      data.forEach(d => {
        d.Confirmed = +d.Confirmed;
        d.Deaths = +d.Deaths;
        d.Population = +d.Population;
      });

      updateScene();

      d3.select("#prev").on("click", () => {
        currentScene = (currentScene + scenes.length - 1) % scenes.length;
        updateScene();
      });

      d3.select("#next").on("click", () => {
        currentScene = (currentScene + 1) % scenes.length;
        updateScene();
      });

      function updateScene() {
        svg.selectAll("*").remove();
        tooltip.style("opacity", 0);
        scenes[currentScene](data);
      }

      function scene1(data) {
        d3.select("#scene-title").text("Scene 1: Total Confirmed Cases by Country");

        const pie = d3.pie().value(d => d.Confirmed);
        const arc = d3.arc().innerRadius(0).outerRadius(radius);
        const color = d3.scaleOrdinal(d3.schemeCategory10);

        const g = svg.append("g")
          .attr("transform", `translate(${width / 2}, ${height / 2})`);

        const arcs = g.selectAll("arc")
          .data(pie(data.filter(d => d.Confirmed > 0)))
          .enter().append("g");

        arcs.append("path")
          .attr("d", arc)
          .attr("fill", d => color(d.data.Country_Region))
          .on("mouseover", (event, d) => {
            tooltip.transition().duration(200).style("opacity", .9);
            tooltip.html(`${d.data.Country_Region}<br>${d.data.Confirmed.toLocaleString()} cases`)
              .style("left", (event.pageX) + "px")
              .style("top", (event.pageY - 28) + "px");
          })
          .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));
      }

      function scene2(data) {
        d3.select("#scene-title").text("Scene 2: Incident Rate (Cases per Person)");

        const dataset = data.filter(d => d.Population > 0).map(d => ({
          country: d.Country_Region,
          rate: d.Confirmed / d.Population
        })).sort((a, b) => b.rate - a.rate).slice(0, 10);

        const x = d3.scaleLinear().domain([0, d3.max(dataset, d => d.rate)]).range([0, width - 200]);
        const y = d3.scaleBand().domain(dataset.map(d => d.country)).range([50, height - 50]).padding(0.2);

        const g = svg.append("g").attr("transform", "translate(100,0)");

        g.selectAll("rect")
          .data(dataset)
          .enter()
          .append("rect")
          .attr("y", d => y(d.country))
          .attr("width", d => x(d.rate))
          .attr("height", y.bandwidth())
          .attr("fill", "steelblue")
          .on("mouseover", (event, d) => {
            tooltip.transition().duration(200).style("opacity", .9);
            tooltip.html(`${d.country}<br>Rate: ${(d.rate * 100).toFixed(2)}%`)
              .style("left", (event.pageX) + "px")
              .style("top", (event.pageY - 28) + "px");
          })
          .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));

        g.append("g").call(d3.axisLeft(y));
        g.append("g").attr("transform", `translate(0, ${height - 50})`).call(d3.axisBottom(x).ticks(5, "%"));
      }

      function scene3(data) {
        d3.select("#scene-title").text("Scene 3: Case Fatality Rate (Deaths per Case)");

        const dataset = data.filter(d => d.Confirmed > 1000).map(d => ({
          country: d.Country_Region,
          rate: d.Deaths / d.Confirmed
        })).sort((a, b) => b.rate - a.rate).slice(0, 10);

        const x = d3.scaleLinear().domain([0, d3.max(dataset, d => d.rate)]).range([0, width - 200]);
        const y = d3.scaleBand().domain(dataset.map(d => d.country)).range([50, height - 50]).padding(0.2);

        const g = svg.append("g").attr("transform", "translate(100,0)");

        g.selectAll("rect")
          .data(dataset)
          .enter()
          .append("rect")
          .attr("y", d => y(d.country))
          .attr("width", d => x(d.rate))
          .attr("height", y.bandwidth())
          .attr("fill", "darkred")
          .on("mouseover", (event, d) => {
            tooltip.transition().duration(200).style("opacity", .9);
            tooltip.html(`${d.country}<br>Fatality Rate: ${(d.rate * 100).toFixed(2)}%`)
              .style("left", (event.pageX) + "px")
              .style("top", (event.pageY - 28) + "px");
          })
          .on("mouseout", () => tooltip.transition().duration(500).style("opacity", 0));

        g.append("g").call(d3.axisLeft(y));
        g.append("g").attr("transform", `translate(0, ${height - 50})`).call(d3.axisBottom(x).ticks(5, "%"));
      }
    });
  </script>
</body>
</html>