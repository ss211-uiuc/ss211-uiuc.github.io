<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>COVID-19 Narrative Visualization</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #fcd56f;
    }
    h1 {
      margin-top: 30px;
      font-size: 32px;
    }
    h2 {
      font-size: 20px;
      margin-bottom: 20px;
    }
    svg {
      margin: auto;
      display: block;
    }
    button {
      margin: 20px 10px;
      padding: 6px 12px;
    }
    .tooltip {
      position: absolute;
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 8px;
      pointer-events: none;
      opacity: 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>COVID-19 Narrative Visualization</h1>
  <h2 id="scene-title"></h2>

  <div id="viz"></div>

  <div>
    <button onclick="prevScene()">Previous</button>
    <button onclick="nextScene()">Next</button>
  </div>

  <script>
    let currentScene = 0;
    const width = 800;
    const height = 500;
    const margin = { top: 50, right: 50, bottom: 100, left: 80 };

    const sceneTitles = [
      "Global Totals",
      "Top 10 Countries by Incident Rate",
      "Top 10 Countries by Case Fatality Ratio"
    ];

    d3.csv("01-01-2021.csv").then(data => {
      data.forEach(d => {
        d.Confirmed = +d.Confirmed;
        d.Deaths = +d.Deaths;
        d.Recovered = +d.Recovered;
        d.Incident_Rate = +d.Incident_Rate;
        d.Case_Fatality_Ratio = +d.Case_Fatality_Ratio;
      });

      data = data.filter(d => d.Confirmed && d.Country_Region);

      renderScene(data);

      window.nextScene = () => {
        currentScene = (currentScene + 1) % 3;
        renderScene(data);
      };

      window.prevScene = () => {
        currentScene = (currentScene + 2) % 3;
        renderScene(data);
      };
    });

    function renderScene(data) {
      d3.select("#scene-title").text(sceneTitles[currentScene]);
      d3.select("#viz").selectAll("*").remove();

      const svg = d3.select("#viz")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      const tooltip = d3.select("#viz")
        .append("div")
        .attr("class", "tooltip");

      if (currentScene === 0) {
        const totals = data.reduce((acc, d) => {
          acc.Confirmed += d.Confirmed;
          acc.Deaths += d.Deaths;
          acc.Recovered += d.Recovered;
          return acc;
        }, { Confirmed: 0, Deaths: 0, Recovered: 0 });

        const pieData = [
          { label: "Confirmed", value: totals.Confirmed },
          { label: "Deaths", value: totals.Deaths },
          { label: "Recovered", value: totals.Recovered }
        ];

        const radius = Math.min(width, height) / 2 - 100;
        const g = svg.append("g")
          .attr("transform", `translate(${width / 2}, ${height / 2})`);

        const color = d3.scaleOrdinal()
          .domain(pieData.map(d => d.label))
          .range(["#1f77b4", "#d62728", "#2ca02c"]);

        const pie = d3.pie().value(d => d.value);
        const arc = d3.arc().innerRadius(0).outerRadius(radius);

        g.selectAll("path")
          .data(pie(pieData))
          .enter()
          .append("path")
          .attr("d", arc)
          .attr("fill", d => color(d.data.label))
          .on("mouseover", function (event, d) {
            tooltip.style("opacity", 1);
          })
          .on("mousemove", function (event, d) {
            tooltip
              .html(`${d.data.label}: ${d.data.value.toLocaleString()}`)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 28 + "px");
          })
          .on("mouseleave", function () {
            tooltip.style("opacity", 0);
          });

        g.selectAll("text")
          .data(pie(pieData))
          .enter()
          .append("text")
          .attr("transform", d => `translate(${arc.centroid(d)})`)
          .attr("text-anchor", "middle")
          .text(d => d.data.label);

      } else if (currentScene === 1) {
        const dataByCountry = d3.nest()
          .key(d => d.Country_Region)
          .rollup(values => {
            const Confirmed = d3.sum(values, d => d.Confirmed);
            const Incident_Rate = d3.mean(values, d => d.Incident_Rate);
            return { Confirmed, Incident_Rate };
          })
          .entries(data)
          .map(d => ({
            Country_Region: d.key,
            ...d.value
          }));

        const top = dataByCountry.sort((a, b) => b.Incident_Rate - a.Incident_Rate).slice(0, 10);

        const x = d3.scaleBand()
          .domain(top.map(d => d.Country_Region))
          .range([margin.left, width - margin.right])
          .padding(0.2);

        const y = d3.scaleLinear()
          .domain([0, d3.max(top, d => d.Incident_Rate)])
          .nice()
          .range([height - margin.bottom, margin.top]);

        svg.append("g")
          .selectAll("rect")
          .data(top)
          .enter()
          .append("rect")
          .attr("x", d => x(d.Country_Region))
          .attr("y", d => y(d.Incident_Rate))
          .attr("width", x.bandwidth())
          .attr("height", d => height - margin.bottom - y(d.Incident_Rate))
          .attr("fill", "steelblue")
          .on("mouseover", function () {
            tooltip.style("opacity", 1);
          })
          .on("mousemove", function (event, d) {
            tooltip
              .html(`${d.Country_Region}<br>Incident Rate: ${d.Incident_Rate.toFixed(2)}`)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 28 + "px");
          })
          .on("mouseleave", function () {
            tooltip.style("opacity", 0);
          });

        svg.append("g")
          .attr("transform", `translate(0, ${height - margin.bottom})`)
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("transform", "rotate(-40)")
          .style("text-anchor", "end");

        svg.append("g")
          .attr("transform", `translate(${margin.left}, 0)`)
          .call(d3.axisLeft(y));

      } else if (currentScene === 2) {
        const top = data
          .filter(d => d.Case_Fatality_Ratio != null)
          .sort((a, b) => b.Case_Fatality_Ratio - a.Case_Fatality_Ratio)
          .slice(0, 10);

        const x = d3.scaleBand()
          .domain(top.map(d => d.Country_Region))
          .range([margin.left, width - margin.right])
          .padding(0.2);

        const y = d3.scaleLinear()
          .domain([0, d3.max(top, d => d.Case_Fatality_Ratio)])
          .nice()
          .range([height - margin.bottom, margin.top]);

        svg.append("g")
          .selectAll("rect")
          .data(top)
          .enter()
          .append("rect")
          .attr("x", d => x(d.Country_Region))
          .attr("y", d => y(d.Case_Fatality_Ratio))
          .attr("width", x.bandwidth())
          .attr("height", d => height - margin.bottom - y(d.Case_Fatality_Ratio))
          .attr("fill", "crimson")
          .on("mouseover", function () {
            tooltip.style("opacity", 1);
          })
          .on("mousemove", function (event, d) {
            tooltip
              .html(`${d.Country_Region}<br>Fatality Ratio: ${d.Case_Fatality_Ratio.toFixed(2)}%`)
              .style("left", event.pageX + 10 + "px")
              .style("top", event.pageY - 28 + "px");
          })
          .on("mouseleave", function () {
            tooltip.style("opacity", 0);
          });

        svg.append("g")
          .attr("transform", `translate(0, ${height - margin.bottom})`)
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("transform", "rotate(-40)")
          .style("text-anchor", "end");

        svg.append("g")
          .attr("transform", `translate(${margin.left}, 0)`)
          .call(d3.axisLeft(y));
      }
    }
  </script>
</body>
</html>
