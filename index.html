<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>COVID Visualization</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body {
      background-color: #fff8dc;
      font-family: sans-serif;
    }
    .tooltip {
      position: absolute;
      opacity: 0;
      background-color: white;
      border: solid 1px #999;
      border-radius: 5px;
      padding: 8px;
      pointer-events: none;
      font-size: 12px;
    }
    .scene {
      display: none;
    }
    .active {
      display: block;
    }
    .nav {
      margin: 10px;
    }
    .nav button {
      padding: 10px;
      margin-right: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="nav">
    <button onclick="showScene(1)">Scene 1</button>
    <button onclick="showScene(2)">Scene 2</button>
    <button onclick="showScene(3)">Scene 3</button>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <div id="scene1" class="scene active"></div>
  <div id="scene2" class="scene"></div>
  <div id="scene3" class="scene"></div>

  <script>
    function showScene(n) {
      d3.selectAll(".scene").classed("active", false);
      d3.select("#scene" + n).classed("active", true);
    }

    const tooltip = d3.select("#tooltip");

    function addTooltip(svg, textAccessor) {
      return {
        mouseover: function (event, d) {
          tooltip.style("opacity", 1);
        },
        mousemove: function (event, d) {
          tooltip
            .html(textAccessor(d))
            .style("left", (event.pageX + 15) + "px")
            .style("top", (event.pageY - 28) + "px");
        },
        mouseleave: function () {
          tooltip.style("opacity", 0);
        }
      };
    }

    const width = 600, height = 400, margin = { top: 40, right: 40, bottom: 60, left: 60 };

    d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/03-01-2023.csv").then(data => {
      data.forEach(d => {
        d.Confirmed = +d.Confirmed || 0;
        d.Deaths = +d.Deaths || 0;
        d.Case_Fatality_Ratio = +d.Case_Fatality_Ratio || 0;
      });

      const grouped = d3.rollups(
        data,
        v => ({
          Confirmed: d3.sum(v, d => d.Confirmed),
          Deaths: d3.sum(v, d => d.Deaths),
          Case_Fatality_Ratio: d3.mean(v, d => d.Case_Fatality_Ratio)
        }),
        d => d.Country_Region
      ).map(([Country, values]) => ({ Country, ...values }));

      // Scene 1: Top 10 countries by confirmed cases
      const topConfirmed = grouped.sort((a, b) => d3.descending(a.Confirmed, b.Confirmed)).slice(0, 10);
      const svg1 = d3.select("#scene1").append("svg")
        .attr("width", width).attr("height", height);

      const x1 = d3.scaleBand().domain(topConfirmed.map(d => d.Country)).range([margin.left, width - margin.right]).padding(0.1);
      const y1 = d3.scaleLinear().domain([0, d3.max(topConfirmed, d => d.Confirmed)]).nice().range([height - margin.bottom, margin.top]);

      svg1.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x1))
        .selectAll("text")
        .attr("transform", "rotate(-45)").style("text-anchor", "end");

      svg1.append("g").attr("transform", `translate(${margin.left},0)`).call(d3.axisLeft(y1));

      const tip1 = addTooltip(svg1, d => `<strong>${d.Country}</strong><br/>Confirmed: ${d.Confirmed.toLocaleString()}`);

      svg1.selectAll("rect")
        .data(topConfirmed)
        .enter()
        .append("rect")
        .attr("x", d => x1(d.Country))
        .attr("y", d => y1(d.Confirmed))
        .attr("width", x1.bandwidth())
        .attr("height", d => y1(0) - y1(d.Confirmed))
        .attr("fill", "steelblue")
        .on("mouseover", tip1.mouseover)
        .on("mousemove", tip1.mousemove)
        .on("mouseleave", tip1.mouseleave);

      // Scene 2: Pie chart of deaths for top 5 countries
      const topDeaths = grouped.sort((a, b) => d3.descending(a.Deaths, b.Deaths)).slice(0, 5);
      const svg2 = d3.select("#scene2").append("svg")
        .attr("width", width).attr("height", height)
        .append("g")
        .attr("transform", `translate(${width / 2}, ${height / 2})`);

      const pie = d3.pie().value(d => d.Deaths);
      const arc = d3.arc().innerRadius(0).outerRadius(Math.min(width, height) / 2 - 40);
      const color = d3.scaleOrdinal(d3.schemeCategory10);

      const tip2 = addTooltip(svg2, d => `<strong>${d.data.Country}</strong><br/>Deaths: ${d.data.Deaths.toLocaleString()}`);

      svg2.selectAll("path")
        .data(pie(topDeaths))
        .enter()
        .append("path")
        .attr("d", arc)
        .attr("fill", d => color(d.data.Country))
        .on("mouseover", tip2.mouseover)
        .on("mousemove", tip2.mousemove)
        .on("mouseleave", tip2.mouseleave);

      // Scene 3: Top 10 countries by Case Fatality Ratio (CFR)
      const topCFR = grouped.filter(d => d.Confirmed > 1000).sort((a, b) => d3.descending(a.Case_Fatality_Ratio, b.Case_Fatality_Ratio)).slice(0, 10);
      const svg3 = d3.select("#scene3").append("svg")
        .attr("width", width).attr("height", height);

      const x3 = d3.scaleBand().domain(topCFR.map(d => d.Country)).range([margin.left, width - margin.right]).padding(0.1);
      const y3 = d3.scaleLinear().domain([0, d3.max(topCFR, d => d.Case_Fatality_Ratio)]).nice().range([height - margin.bottom, margin.top]);

      svg3.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x3))
        .selectAll("text")
        .attr("transform", "rotate(-45)").style("text-anchor", "end");

      svg3.append("g").attr("transform", `translate(${margin.left},0)`).call(d3.axisLeft(y3));

      const tip3 = addTooltip(svg3, d => `<strong>${d.Country}</strong><br/>CFR: ${d.Case_Fatality_Ratio.toFixed(2)}%`);

      svg3.selectAll("rect")
        .data(topCFR)
        .enter()
        .append("rect")
        .attr("x", d => x3(d.Country))
        .attr("y", d => y3(d.Case_Fatality_Ratio))
        .attr("width", x3.bandwidth())
        .attr("height", d => y3(0) - y3(d.Case_Fatality_Ratio))
        .attr("fill", "tomato")
        .on("mouseover", tip3.mouseover)
        .on("mousemove", tip3.mousemove)
        .on("mouseleave", tip3.mouseleave);
    });
  </script>
</body>
</html>
